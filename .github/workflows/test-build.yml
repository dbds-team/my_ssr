name: Test Build

on:
  workflow_dispatch: # ä»…å…è®¸æ‰‹åŠ¨è§¦å‘
    inputs:
      debug_level:
        description: 'è°ƒè¯•çº§åˆ« (basic/detailed/full)'
        required: false
        default: 'basic'
        type: choice
        options:
          - basic
          - detailed  
          - full
      test_signing:
        description: 'æµ‹è¯•ç­¾ååŠŸèƒ½'
        required: false
        default: false
        type: boolean

jobs:
  test-build:
    runs-on: ubuntu-22.04
    timeout-minutes: 45
    
    env:
      NDK_VERSION: android-ndk-r12b
      SDK_TOOLS: 4333796
      SCALA_VERSION: scala-2.11.8
      
    steps:
    - name: ğŸ” ç¯å¢ƒä¿¡æ¯
      run: |
        echo "ğŸ” æµ‹è¯•æ„å»ºå¼€å§‹"
        echo "ğŸ“‹ æ„å»ºç¯å¢ƒä¿¡æ¯:"
        echo "  è¿è¡Œå™¨: $(uname -a)"
        echo "  è°ƒè¯•çº§åˆ«: ${{ github.event.inputs.debug_level }}"
        echo "  æµ‹è¯•ç­¾å: ${{ github.event.inputs.test_signing }}"
        echo "  è§¦å‘äº‹ä»¶: ${{ github.event_name }}"
        echo "  å·¥ä½œç›®å½•: $(pwd)"
        
    - name: ğŸ“¥ Checkoutä»£ç 
      uses: actions/checkout@v4
      
    - name: ğŸ” ä»£ç åº“æ£€æŸ¥
      run: |
        echo "ğŸ“‹ ä»£ç åº“åŸºæœ¬ä¿¡æ¯:"
        echo "  åˆ†æ”¯: $(git branch --show-current || echo 'æœªçŸ¥')"
        echo "  æœ€æ–°æäº¤: $(git log -1 --oneline || echo 'æ— æäº¤')"
        echo "  é¡¹ç›®æ ¹ç›®å½•æ–‡ä»¶:"
        ls -la
        
        echo "ğŸ“‹ æ„å»ºæ–‡ä»¶æ£€æŸ¥:"
        echo "  build.sbt: $([ -f build.sbt ] && echo 'âœ…' || echo 'âŒ')"
        echo "  build.sh: $([ -f build.sh ] && echo 'âœ…' || echo 'âŒ')"
        echo "  travis-ci/setup.sh: $([ -f travis-ci/setup.sh ] && echo 'âœ…' || echo 'âŒ')"
        
    - name: â˜• è®¾ç½®JDK 1.8
      uses: actions/setup-java@v4
      with:
        distribution: 'adopt'
        java-version: '8'
        
    - name: ğŸ” Javaç¯å¢ƒæ£€æŸ¥
      run: |
        echo "â˜• Javaç¯å¢ƒä¿¡æ¯:"
        java -version
        javac -version
        echo "JAVA_HOME: $JAVA_HOME"
        
    - name: ğŸ”§ æ¢å¤Androidç¼“å­˜
      uses: actions/cache@v4
      with:
        path: ~/.android-cache
        key: test-${{ runner.os }}-android-${{ env.NDK_VERSION }}-${{ env.SDK_TOOLS }}-${{ env.SCALA_VERSION }}
        restore-keys: |
          test-${{ runner.os }}-android-${{ env.NDK_VERSION }}-${{ env.SDK_TOOLS }}
          ${{ runner.os }}-android-${{ env.NDK_VERSION }}-${{ env.SDK_TOOLS }}
          
    - name: ğŸ”§ æ¢å¤SBTç¼“å­˜
      uses: actions/cache@v4
      with:
        path: |
          ~/.ivy2/cache
          ~/.sbt
        key: test-${{ runner.os }}-sbt-${{ hashFiles('**/build.sbt') }}
        restore-keys: |
          test-${{ runner.os }}-sbt-
          ${{ runner.os }}-sbt-
          
    - name: ğŸ—ï¸ å®‰è£…Scala (è¯¦ç»†æ¨¡å¼)
      run: |
        echo "ğŸ“¦ å®‰è£…Scala ${{ env.SCALA_VERSION }}..."
        mkdir -p ~/.android-cache
        
        if [ ! -f ~/.android-cache/scala-2.11.8.deb ]; then
          echo "â¬‡ï¸ ä¸‹è½½ScalaåŒ…..."
          wget -O ~/.android-cache/scala-2.11.8.deb https://www.scala-lang.org/files/archive/scala-2.11.8.deb
          echo "ğŸ“¦ ä¸‹è½½çš„æ–‡ä»¶å¤§å°: $(ls -lh ~/.android-cache/scala-2.11.8.deb | awk '{print $5}')"
        else
          echo "âœ… ä½¿ç”¨ç¼“å­˜çš„ScalaåŒ…"
          echo "ğŸ“¦ ç¼“å­˜æ–‡ä»¶å¤§å°: $(ls -lh ~/.android-cache/scala-2.11.8.deb | awk '{print $5}')"
        fi
        
        echo "ğŸ”§ å®‰è£…ScalaåŒ…..."
        sudo dpkg -i ~/.android-cache/scala-2.11.8.deb
        
        echo "ğŸ” éªŒè¯Scalaå®‰è£…:"
        scala -version || echo "âŒ Scalaç‰ˆæœ¬æ£€æŸ¥å¤±è´¥"
        echo "âœ… Scalaå®‰è£…å®Œæˆ"
        
    - name: ğŸ—ï¸ å®‰è£…SBT (è¯¦ç»†æ¨¡å¼)
      run: |
        echo "ğŸ“¦ å®‰è£…SBT..."
        echo "deb https://dl.bintray.com/sbt/debian /" | sudo tee -a /etc/apt/sources.list.d/sbt.list
        
        echo "ğŸ” æ·»åŠ SBT GPGå¯†é’¥..."
        sudo apt-key adv --keyserver hkp://keyserver.ubuntu.com:80 --recv 2EE0EA64E40A89B84B2DF73499E82A75642AC823
        
        echo "ğŸ”„ æ›´æ–°åŒ…ç´¢å¼•..."
        sudo apt-get update -qq
        
        echo "ğŸ“¦ å®‰è£…SBTåŒ…..."
        sudo apt-get install -y sbt
        
        echo "ğŸ” éªŒè¯SBTå®‰è£…:"
        sbt --version || echo "âŒ SBTç‰ˆæœ¬æ£€æŸ¥å¤±è´¥"
        echo "âœ… SBTå®‰è£…å®Œæˆ"
        
    - name: ğŸ—ï¸ å®‰è£…æ„å»ºä¾èµ–
      run: |
        echo "ğŸ“¦ å®‰è£…æ„å»ºä¾èµ–..."
        sudo apt-get --quiet install --yes wget tar unzip gcc-multilib g++-multilib libstdc++6 libgcc1 zlib1g libncurses5
        
        echo "ğŸ” éªŒè¯ä¾èµ–å®‰è£…:"
        gcc --version | head -1
        g++ --version | head -1
        echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
        
    - name: ğŸ”§ åˆå§‹åŒ–Application.mk
      run: |
        echo "ğŸ“ åˆ›å»ºApplication.mké…ç½®..."
        echo -e "APP_ABI      			:= armeabi-v7a x86\nAPP_PLATFORM 			:= android-16\nAPP_STL      			:= stlport_static\nNDK_TOOLCHAIN_VERSION 	:= clang\n" > './src/main/jni/Application.mk'
        
        echo "ğŸ“‹ Application.mkå†…å®¹:"
        cat './src/main/jni/Application.mk'
        echo "âœ… Application.mkåˆ›å»ºå®Œæˆ"
        
    - name: ğŸ” æµ‹è¯•ç­¾åé…ç½®
      if: ${{ github.event.inputs.test_signing == 'true' }}
      env:
        KEY_JKS: ${{ secrets.KEY_JKS }}
        ALIAS: ${{ secrets.ALIAS }}
        ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        ANDROID_STORE_PASSWORD: ${{ secrets.ANDROID_STORE_PASSWORD }}
      run: |
        echo "ğŸ” æµ‹è¯•ç­¾åé…ç½®..."
        
        if [ -z "$KEY_JKS" ]; then
          echo "âŒ KEY_JKS secretæœªé…ç½®"
        else
          echo "âœ… KEY_JKS secretå·²é…ç½® (é•¿åº¦: ${#KEY_JKS})"
        fi
        
        if [ -z "$ALIAS" ]; then
          echo "âŒ ALIAS secretæœªé…ç½®"
        else
          echo "âœ… ALIAS secretå·²é…ç½®: $ALIAS"
        fi
        
        if [ -z "$ANDROID_KEY_PASSWORD" ]; then
          echo "âŒ ANDROID_KEY_PASSWORD secretæœªé…ç½®"
        else
          echo "âœ… ANDROID_KEY_PASSWORD secretå·²é…ç½®"
        fi
        
        if [ -z "$ANDROID_STORE_PASSWORD" ]; then
          echo "âŒ ANDROID_STORE_PASSWORD secretæœªé…ç½®"
        else
          echo "âœ… ANDROID_STORE_PASSWORD secretå·²é…ç½®"
        fi
        
        # å¦‚æœæ‰€æœ‰secretséƒ½é…ç½®äº†ï¼Œæµ‹è¯•è§£ç è¯ä¹¦
        if [ -n "$KEY_JKS" ] && [ -n "$ALIAS" ] && [ -n "$ANDROID_KEY_PASSWORD" ] && [ -n "$ANDROID_STORE_PASSWORD" ]; then
          echo "ğŸ”§ æµ‹è¯•è¯ä¹¦è§£ç ..."
          echo "$KEY_JKS" | base64 --decode > test-key.jks 2>/dev/null
          if [ $? -eq 0 ]; then
            echo "âœ… è¯ä¹¦è§£ç æˆåŠŸ"
            echo "ğŸ“¦ è¯ä¹¦æ–‡ä»¶å¤§å°: $(ls -lh test-key.jks | awk '{print $5}')"
            rm test-key.jks
          else
            echo "âŒ è¯ä¹¦è§£ç å¤±è´¥"
          fi
        fi
        
    - name: ğŸ” é¢„æ„å»ºæ£€æŸ¥
      run: |
        echo "ğŸ” æ„å»ºå‰ç¯å¢ƒæ£€æŸ¥..."
        
        echo "ğŸ“‹ å…³é”®ç›®å½•æ£€æŸ¥:"
        echo "  src/mainå­˜åœ¨: $([ -d src/main ] && echo 'âœ…' || echo 'âŒ')"
        echo "  src/main/jniå­˜åœ¨: $([ -d src/main/jni ] && echo 'âœ…' || echo 'âŒ')"
        echo "  travis-ciå­˜åœ¨: $([ -d travis-ci ] && echo 'âœ…' || echo 'âŒ')"
        
        echo "ğŸ“‹ å…³é”®æ–‡ä»¶æ£€æŸ¥:"
        echo "  build.sbt: $([ -f build.sbt ] && echo 'âœ…' || echo 'âŒ')"
        echo "  build.sh: $([ -f build.sh ] && echo 'âœ…' || echo 'âŒ')"
        echo "  Application.mk: $([ -f src/main/jni/Application.mk ] && echo 'âœ…' || echo 'âŒ')"
        echo "  setup.sh: $([ -f travis-ci/setup.sh ] && echo 'âœ…' || echo 'âŒ')"
        
        if [ "${{ github.event.inputs.debug_level }}" = "detailed" ] || [ "${{ github.event.inputs.debug_level }}" = "full" ]; then
          echo "ğŸ“‹ è¯¦ç»†æ–‡ä»¶åˆ—è¡¨:"
          echo "  src/main/jniå†…å®¹:"
          ls -la src/main/jni/ | head -10
          echo "  travis-ciå†…å®¹:"
          ls -la travis-ci/
        fi
        
    - name: ğŸš€ æµ‹è¯•æ„å»º (åŸºç¡€)
      if: ${{ github.event.inputs.debug_level == 'basic' }}
      run: |
        echo "ğŸš€ å¼€å§‹åŸºç¡€æµ‹è¯•æ„å»º..."
        chmod +x ./travis-ci/setup.sh
        
        # è®¾ç½®è¶…æ—¶å’Œé”™è¯¯å¤„ç†
        timeout 1800 ./travis-ci/setup.sh || {
          echo "âŒ æ„å»ºå¤±è´¥æˆ–è¶…æ—¶"
          exit 1
        }
        
        echo "âœ… åŸºç¡€æ„å»ºæµ‹è¯•å®Œæˆ"
        
    - name: ğŸš€ æµ‹è¯•æ„å»º (è¯¦ç»†)
      if: ${{ github.event.inputs.debug_level == 'detailed' }}
      run: |
        echo "ğŸš€ å¼€å§‹è¯¦ç»†æµ‹è¯•æ„å»º..."
        chmod +x ./travis-ci/setup.sh
        
        echo "ğŸ“‹ æ„å»ºè„šæœ¬å†…å®¹é¢„è§ˆ:"
        head -20 ./travis-ci/setup.sh
        
        # è¯¦ç»†æ¨¡å¼æ„å»º
        timeout 1800 bash -x ./travis-ci/setup.sh || {
          echo "âŒ è¯¦ç»†æ„å»ºå¤±è´¥æˆ–è¶…æ—¶"
          echo "ğŸ“‹ æœ€åçš„ç›®å½•çŠ¶æ€:"
          find . -name "*.apk" -o -name "*.log" | head -10
          exit 1
        }
        
        echo "âœ… è¯¦ç»†æ„å»ºæµ‹è¯•å®Œæˆ"
        
    - name: ğŸš€ æµ‹è¯•æ„å»º (å®Œæ•´)
      if: ${{ github.event.inputs.debug_level == 'full' }}
      run: |
        echo "ğŸš€ å¼€å§‹å®Œæ•´æµ‹è¯•æ„å»º..."
        chmod +x ./travis-ci/setup.sh
        
        echo "ğŸ“‹ å®Œæ•´æ„å»ºè„šæœ¬å†…å®¹:"
        cat ./travis-ci/setup.sh
        
        echo "ğŸ“‹ å¼€å§‹æ„å»ºï¼Œå¯ç”¨å®Œæ•´è°ƒè¯•..."
        # å®Œæ•´è°ƒè¯•æ¨¡å¼
        set -x
        timeout 1800 ./travis-ci/setup.sh || {
          echo "âŒ å®Œæ•´æ„å»ºå¤±è´¥æˆ–è¶…æ—¶"
          echo "ğŸ“‹ æ„å»ºç¯å¢ƒçŠ¶æ€:"
          env | grep -E "(ANDROID|JAVA|SBT|SCALA)" | sort
          echo "ğŸ“‹ æ–‡ä»¶æœç´¢ç»“æœ:"
          find . -name "*.apk" -o -name "*.log" -o -name "target" | head -20
          exit 1
        }
        set +x
        
        echo "âœ… å®Œæ•´æ„å»ºæµ‹è¯•å®Œæˆ"
        
    - name: ğŸ“ æ„å»ºç»“æœæ£€æŸ¥
      run: |
        echo "ğŸ“ æ„å»ºç»“æœæ£€æŸ¥..."
        
        echo "ğŸ“‹ æŸ¥æ‰¾APKæ–‡ä»¶:"
        find . -name "*.apk" -type f 2>/dev/null | while read apk; do
          echo "  å‘ç°APK: $apk ($(ls -lh "$apk" | awk '{print $5}'))"
        done
        
        echo "ğŸ“‹ targetç›®å½•ç»“æ„:"
        if [ -d target ]; then
          find target -type f -name "*.apk" -o -name "*.log" | head -10
        else
          echo "  targetç›®å½•ä¸å­˜åœ¨"
        fi
        
        echo "ğŸ“‹ è¾“å‡ºç›®å½•æ£€æŸ¥:"
        if [ -d ./target/android/output/ ]; then
          echo "  è¾“å‡ºç›®å½•å­˜åœ¨ï¼Œå†…å®¹:"
          ls -la ./target/android/output/
        else
          echo "  è¾“å‡ºç›®å½•ä¸å­˜åœ¨"
        fi
        
    - name: ğŸ“¦ ä¸Šä¼ æµ‹è¯•ç»“æœ
      if: always()
      uses: actions/upload-artifact@v4
      with:
        name: test-build-results-${{ github.run_number }}
        path: |
          target/android/output/*.apk
          **/*.log
        retention-days: 7
        if-no-files-found: ignore
        
    - name: ğŸŠ æµ‹è¯•å®Œæˆ
      run: |
        echo "ğŸŠ æµ‹è¯•æ„å»ºå®Œæˆ!"
        echo "ğŸ“‹ æµ‹è¯•æ€»ç»“:"
        echo "  è°ƒè¯•çº§åˆ«: ${{ github.event.inputs.debug_level }}"
        echo "  ç­¾åæµ‹è¯•: ${{ github.event.inputs.test_signing }}"
        echo "  æ„å»ºçŠ¶æ€: $([ $? -eq 0 ] && echo 'æˆåŠŸ' || echo 'å¤±è´¥')"
        echo "ğŸ“ å¦‚æœæ„å»ºå¤±è´¥ï¼Œè¯·æ£€æŸ¥ä¸Šä¼ çš„artifactsè·å–è¯¦ç»†æ—¥å¿—" 