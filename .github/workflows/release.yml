name: Build and Release

on:
  push:
    tags:
      - 'v*' # åªæœ‰æ¨é€å¸¦vçš„tagæ—¶æ‰è§¦å‘ç¼–è¯‘å’Œå‘å¸ƒ
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  build-and-release:
    runs-on: ubuntu-22.04
    timeout-minutes: 60 # è®¾ç½®è¶…æ—¶é¿å…å¡ä½
    
    env:
      NDK_VERSION: android-ndk-r12b
      SDK_TOOLS: 4333796
      SCALA_VERSION: scala-2.11.8
      
    steps:
    - name: ğŸ“¥ Checkoutä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0 # è·å–å®Œæ•´å†å²ç”¨äºç”Ÿæˆchangelog
        
    - name: ğŸ“‹ è·å–ç‰ˆæœ¬ä¿¡æ¯
      id: version
      run: |
        VERSION=${GITHUB_REF#refs/tags/}
        echo "version=$VERSION" >> $GITHUB_OUTPUT
        echo "version_number=${VERSION#v}" >> $GITHUB_OUTPUT
        echo "ğŸ“Œ æ„å»ºç‰ˆæœ¬: $VERSION"
        
    - name: â˜• è®¾ç½®JDK 1.8
      uses: actions/setup-java@v4
      with:
        distribution: 'adopt'
        java-version: '8'
        
    - name: ğŸ”§ æ¢å¤Androidç¼“å­˜
      uses: actions/cache@v4
      with:
        path: ~/.android-cache
        key: ${{ runner.os }}-android-${{ env.NDK_VERSION }}-${{ env.SDK_TOOLS }}-${{ env.SCALA_VERSION }}
        restore-keys: |
          ${{ runner.os }}-android-${{ env.NDK_VERSION }}-${{ env.SDK_TOOLS }}
          
    - name: ğŸ”§ æ¢å¤SBT ivyç¼“å­˜
      uses: actions/cache@v4
      with:
        path: ~/.ivy2/cache
        key: ${{ runner.os }}-sbt-ivy-cache-${{ hashFiles('**/build.sbt') }}
        restore-keys: |
          ${{ runner.os }}-sbt-ivy-cache-
          
    - name: ğŸ”§ æ¢å¤SBTç¼“å­˜
      uses: actions/cache@v4
      with:
        path: ~/.sbt
        key: ${{ runner.os }}-sbt-${{ hashFiles('**/build.sbt') }}
        restore-keys: |
          ${{ runner.os }}-sbt-
          
    - name: ğŸ—ï¸ å®‰è£…Scala
      run: |
        echo "ğŸ“¦ å®‰è£…Scala ${{ env.SCALA_VERSION }}..."
        mkdir -p ~/.android-cache
        if [ ! -f ~/.android-cache/scala-2.11.8.deb ]; then
          echo "â¬‡ï¸ ä¸‹è½½ScalaåŒ…..."
          wget -O ~/.android-cache/scala-2.11.8.deb https://www.scala-lang.org/files/archive/scala-2.11.8.deb
        else
          echo "âœ… ä½¿ç”¨ç¼“å­˜çš„ScalaåŒ…"
        fi
        sudo dpkg -i ~/.android-cache/scala-2.11.8.deb
        echo "âœ… Scalaå®‰è£…å®Œæˆ"
        
    - name: ğŸ—ï¸ å®‰è£…SBT
      run: |
        echo "ğŸ“¦ å®‰è£…SBT..."
        echo "deb https://repo.scala-sbt.org/scalasbt/debian all main" | sudo tee /etc/apt/sources.list.d/sbt.list
        echo "deb https://repo.scala-sbt.org/scalasbt/debian /" | sudo tee -a /etc/apt/sources.list.d/sbt.list
        curl -sL "https://keyserver.ubuntu.com/pks/lookup?op=get&search=0x2EE0EA64E40A89B84B2DF73499E82A75642AC823" | sudo apt-key add
        sudo apt-get update -qq
        sudo apt-get install -y sbt
        echo "âœ… SBTå®‰è£…å®Œæˆ"
        
    - name: ğŸ—ï¸ å®‰è£…ä¾èµ–åŒ…
      run: |
        echo "ğŸ“¦ å®‰è£…æ„å»ºä¾èµ–..."
        sudo apt-get --quiet install --yes wget tar unzip gcc-multilib g++-multilib libstdc++6 libgcc1 zlib1g libncurses5
        echo "âœ… ä¾èµ–å®‰è£…å®Œæˆ"
        
    - name: ğŸ”§ åˆå§‹åŒ–Application.mk
      run: |
        echo "ğŸ“ åˆ›å»ºApplication.mké…ç½®..."
        echo -e "APP_ABI      			:= armeabi-v7a x86\nAPP_PLATFORM 			:= android-16\nAPP_STL      			:= stlport_static\nNDK_TOOLCHAIN_VERSION 	:= clang\n" > './src/main/jni/Application.mk'
        echo "âœ… Application.mkåˆ›å»ºå®Œæˆ"
        cat './src/main/jni/Application.mk'
        
    - name: ğŸ” è®¾ç½®ç­¾åå¯†é’¥
      if: ${{ env.KEY_JKS != '' }}
      env:
        KEY_JKS: ${{ secrets.KEY_JKS }}
        ALIAS: ${{ secrets.ALIAS }}
        ANDROID_KEY_PASSWORD: ${{ secrets.ANDROID_KEY_PASSWORD }}
        ANDROID_STORE_PASSWORD: ${{ secrets.ANDROID_STORE_PASSWORD }}
      run: |
        echo "ğŸ” é…ç½®APKç­¾å..."
        # è§£ç è¯ä¹¦æ–‡ä»¶
        echo "$KEY_JKS" | base64 --decode > release-key.jks
        echo "âœ… ç­¾åå¯†é’¥é…ç½®å®Œæˆ"
        
        # åˆ›å»ºç­¾åé…ç½®æ–‡ä»¶
        echo "storeFile=../release-key.jks" > local.properties
        echo "storePassword=$ANDROID_STORE_PASSWORD" >> local.properties
        echo "keyAlias=$ALIAS" >> local.properties
        echo "keyPassword=$ANDROID_KEY_PASSWORD" >> local.properties
        echo "âœ… ç­¾åé…ç½®æ–‡ä»¶åˆ›å»ºå®Œæˆ"
        
    - name: ğŸ—ï¸ æ„å»ºAPK
      run: |
        echo "ğŸš€ å¼€å§‹æ„å»ºRelease APK..."
        echo "ğŸ“‹ æ„å»ºä¿¡æ¯:"
        echo "  ç‰ˆæœ¬: ${{ steps.version.outputs.version }}"
        echo "  é¡¹ç›®: shadowsocksr-v2ray"
        echo "  ç›®æ ‡: release"
        
        # è®¾ç½®æ„å»ºç¯å¢ƒ
        chmod +x ./travis-ci/setup.sh
        ./travis-ci/setup.sh
        
        echo "âœ… APKæ„å»ºå®Œæˆ"
        
    - name: ğŸ“ æ£€æŸ¥æ„å»ºç»“æœ
      run: |
        echo "ğŸ“‹ æ„å»ºè¾“å‡ºç›®å½•å†…å®¹:"
        ls -la ./target/android/output/ || echo "è¾“å‡ºç›®å½•ä¸å­˜åœ¨"
        
        echo "ğŸ“‹ æŸ¥æ‰¾APKæ–‡ä»¶:"
        find . -name "*.apk" -type f | head -10
        
    - name: ğŸ“ é‡å‘½åAPKæ–‡ä»¶
      id: rename
      run: |
        echo "ğŸ“ é‡å‘½åAPKæ–‡ä»¶..."
        cd ./target/android/output/
        
        # æŸ¥æ‰¾release apkæ–‡ä»¶
        if [ -f "shadowsocksr-v2ray-release.apk" ]; then
          OLD_NAME="shadowsocksr-v2ray-release.apk"
        elif [ -f "app-release.apk" ]; then
          OLD_NAME="app-release.apk"
        else
          echo "âŒ æœªæ‰¾åˆ°release APKæ–‡ä»¶"
          ls -la
          exit 1
        fi
        
        # æ–°æ–‡ä»¶å: é¡¹ç›®å+ç‰ˆæœ¬å·+.apk
        NEW_NAME="shadowsocksr-v2ray-${{ steps.version.outputs.version }}.apk"
        
        mv "$OLD_NAME" "$NEW_NAME"
        echo "âœ… APKæ–‡ä»¶é‡å‘½å: $OLD_NAME -> $NEW_NAME"
        echo "apk_name=$NEW_NAME" >> $GITHUB_OUTPUT
        echo "apk_path=$(pwd)/$NEW_NAME" >> $GITHUB_OUTPUT
        
        # æ˜¾ç¤ºæœ€ç»ˆæ–‡ä»¶ä¿¡æ¯
        ls -lh "$NEW_NAME"
        
    - name: ğŸ“¦ ä¸Šä¼ APKåˆ°Artifacts
      uses: actions/upload-artifact@v4
      with:
        name: shadowsocksr-v2ray-${{ steps.version.outputs.version }}
        path: ${{ steps.rename.outputs.apk_path }}
        retention-days: 30
        
    - name: ğŸ“Š ç”ŸæˆReleaseè¯´æ˜
      id: changelog
      run: |
        echo "ğŸ“Š ç”ŸæˆReleaseè¯´æ˜..."
        
        # è·å–ä¸Šä¸€ä¸ªtag
        PREV_TAG=$(git tag --sort=-version:refname | grep "^v" | head -2 | tail -1)
        if [ -z "$PREV_TAG" ]; then
          PREV_TAG=$(git rev-list --max-parents=0 HEAD)
        fi
        
        echo "ğŸ” å¯¹æ¯”èŒƒå›´: $PREV_TAG..${{ steps.version.outputs.version }}"
        
        # ç”Ÿæˆchangelog
        cat > release_notes.md << EOF
        ## ğŸš€ ShadowsocksR V2Ray ${{ steps.version.outputs.version }}
        
        ### ğŸ“‹ ç‰ˆæœ¬ä¿¡æ¯
        - **ç‰ˆæœ¬å·**: ${{ steps.version.outputs.version }}
        - **æ„å»ºæ—¶é—´**: $(date '+%Y-%m-%d %H:%M:%S UTC')
        - **æ„å»ºåˆ†æ”¯**: ${GITHUB_REF#refs/tags/}
        
        ### ğŸ“¦ ä¸‹è½½ä¿¡æ¯
        - **APKæ–‡ä»¶**: ${{ steps.rename.outputs.apk_name }}
        - **æ–‡ä»¶å¤§å°**: $(ls -lh ${{ steps.rename.outputs.apk_path }} | awk '{print $5}')
        
        ### ğŸ“ æ›´æ–°å†…å®¹
        EOF
        
        # æ·»åŠ æäº¤å†å²
        git log --pretty=format:"- %s (%h)" $PREV_TAG..${{ steps.version.outputs.version }} >> release_notes.md
        
        echo "âœ… Releaseè¯´æ˜ç”Ÿæˆå®Œæˆ"
        cat release_notes.md
        
    - name: ğŸ‰ åˆ›å»ºGitHub Release
      uses: softprops/action-gh-release@v1
      with:
        tag_name: ${{ steps.version.outputs.version }}
        name: ShadowsocksR V2Ray ${{ steps.version.outputs.version }}
        body_path: release_notes.md
        files: ${{ steps.rename.outputs.apk_path }}
        draft: false
        prerelease: ${{ contains(steps.version.outputs.version, 'beta') || contains(steps.version.outputs.version, 'alpha') || contains(steps.version.outputs.version, 'rc') }}
        generate_release_notes: false
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        
    - name: ğŸŠ æ„å»ºå®Œæˆ
      run: |
        echo "ğŸŠ æ„å»ºå’Œå‘å¸ƒå®Œæˆ!"
        echo "ğŸ“¦ APKæ–‡ä»¶: ${{ steps.rename.outputs.apk_name }}"
        echo "ğŸ”— Releaseé“¾æ¥: https://github.com/${{ github.repository }}/releases/tag/${{ steps.version.outputs.version }}" 